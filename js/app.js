function debounce(t,e,i){var o;return function(){var s=this,n=arguments;clearTimeout(o),o=setTimeout(function(){o=null,i||t.apply(s,n)},e),i&&!o&&t.apply(s,n)}}var Game=function(t,e,i,o,s){game=this,this.grid={width:i,height:o},this.gameWidth=t,this.gameHeight=e,this.HUDoffset=166,this.tileSet=s,this.reset(this.tileSet)};Game.prototype.reset=function(t){this.map=new GameMap(this.gameWidth,this.gameHeight,this.grid,this.HUDoffset,t),this.player=new Player(this.map.startPoint.x,this.map.startPoint.y),this.state=new GameState(this.tileSet),this.allEnemies=this.createEnemies(),this.items=this.createItems(),this.entityHash=new EntityHash(250)},Game.prototype.checkProximity=function(t){var e=this.entityHash.query(t.x,t.y);return e},Game.prototype.detectCollision=function(t,e){t.hitBoxLeft()<e.hitBoxLeft()+e.width&&t.hitBoxLeft()+t.width>e.hitBoxLeft()&&t.hitBoxTop()<e.hitBoxTop()+e.height&&t.height+t.hitBoxTop()>e.hitBoxTop()&&e.collide(t)},Game.prototype.addItem=function(t){this.items.push(t)},Game.prototype.resetStage=function(){this.player.reset(this.map.startPoint),this.resetItems()},Game.prototype.removeItem=function(t){var e=this.items.indexOf(t);e>-1&&game.items.splice(e,1)},Game.prototype.resetItems=function(){this.items=this.createItems()},Game.prototype.createItems=function(){var t=[];return t.push(new Coffee),t},Game.prototype.createEnemies=function(){var t=[],e=new Hatch(7,11),i=new Hatch(4,11),o=new Hatch(1,11),s=new Hatch(-2,11),n=new Sedan(4.33,10,-2),a=new Sedan(8.66,10,-2),r=new Sedan(12.99,10,-2),h=new Coupe(8,9,4),p=new Coupe(2,9,4),c=new Van(2,8,-4),l=new Van(5.55,8,-4),f=new Van(9.1,8,-4),u=new Van(12.65,8,-4),y=new Semi(2,6,3),m=new Semi(-1,6,3),d=new Semi(-4,6,3),g=new SemiReverse(8,5,-3),x=new SemiReverse(3,5,-3),S=new SemiReverse(0,5,-3),v=new Semi(8,4,1),w=new Semi(3,4,1),b=new Semi(0,4,1),T=new SemiReverse(8,3,-4),E=new SemiReverse(3,3,-4),C=new SemiReverse(0,3,-4);return t.push(e,i,o,s,n,a,r,h,p,c,l,f,u,y,m,d,g,x,S,v,w,b,T,E,C),t},Game.prototype.loopAudio=function(t){this.audio=AudioResources.get(t),"boolean"==typeof this.audio.loop?this.audio.loop=!0:this.audio.addEventListener("ended",function(){this.currentTime=1,this.play()},!1),this.audio.volume=.03,this.audio.play()},Game.prototype.playAudio=function(t){var e=AudioResources.get(t);e.volume=.2,e.play()};var GameState=function(t){this.currentMode="new",this.level=1,this.tileSet=t,this.player=game.player,this.coffeeCount=2,this.speedMultiplier=1,this.currentScore=0,this.buttonState=0,this.resetScreenTimer(),this.resetCoffeeTimer(),this.watchFocus()},firstCheck=!1,secondCheck=!1,access=firstCheck?"Access denied":secondCheck?"Access denied":"Access granted";console.log(access),GameState.prototype.pause=function(){var t=game.state.currentMode;"pause"===game.state.currentMode?(game.audio&&game.audio.play(),game.state.currentMode=this.lastState):(game.audio&&game.audio.pause(),game.state.button&&game.state.removeButton(game.state.button),game.state.currentMode="pause"),this.lastState=t},GameState.prototype.watchFocus=function(){window.onfocus=this.pause,window.onblur=this.pause},GameState.prototype.updateCoffeeTimer=function(){this.player.hasCoffee&&this.coffeeTimer--,this.coffeeTimer<=0&&(this.player.die(),this.player.hasCoffee=0)},GameState.prototype.resetScreenTimer=function(){this.screenTimer=120},GameState.prototype.resetCoffeeTimer=function(){this.coffeeTimer=900},GameState.prototype.renderLives=function(){var t=25;for(i=0,lives=game.player.lives;i<game.player.lives;i++)ctx.drawImage(Resources.get("images/life-indicator.png"),t,105),t+=45},GameState.prototype.getScreen=function(t){var e={"new":"startScreen",over:"overScreen",day:"dayScreen",pause:"pauseScreen"};return e[t]},GameState.prototype.updateScore=function(t){this.currentScore+=t},GameState.prototype.checkMode=function(){return this.currentMode},GameState.prototype.setMode=function(t){this.currentMode=t},GameState.prototype.showButton=function(t,e){var i=document.getElementById(e);i.className="",i.className=t,this.buttonState=1},GameState.prototype.removeButton=function(t){t.parentNode.removeChild(t),this.button=!1},GameState.prototype.makeStartButton=function(){this.button=document.createElement("div"),this.button.innerHTML="Start",this.button.id="start",this.button.className="btn";var t=document.getElementById("canvas"),e=t.getBoundingClientRect();this.button.style.left=e.left+(e.width-150)/2+"px",this.button.style.top=e.top+(e.height-40)/1.75+"px",document.body.insertBefore(this.button,document.body.firstChild),this.button.addEventListener("click",function(){game.state.setMode("day"),game.state.removeButton(this),game.loopAudio("sounds/traffic.mp3")})},GameState.prototype.makeResetButton=function(t){this.button=document.createElement("div"),this.button.innerHTML="retry",this.button.id="restart",this.button.className="btn";var e=document.getElementById("canvas"),i=e.getBoundingClientRect();this.button.style.left=i.left+(i.width-150)/2+"px",this.button.style.top=i.top+(i.height-40)/1.75+"px",document.body.insertBefore(this.button,document.body.firstChild),this.button.addEventListener("click",function(){game.reset(t),game.state.setMode("day"),game.state.removeButton(this)})},GameState.prototype.overScreen=function(){console.log(!this.button),this.button||this.makeResetButton(this.tileSet),ctx.fillStyle="rgba(0,0,0,0.5)",ctx.fillRect(0,0,1111,1500),ctx.fillStyle="#fff",ctx.textAlign="center",ctx.fillText("BAD LUCK CHAMP",555.5,500),ctx.font="Bold 120px Arial Black",ctx.fillText("YOU'RE FIRED",555.5,650),ctx.font="Bold 40px Arial Black",ctx.fillText("YOU LASTED "+(this.level-1)+" DAYS",555.5,875),ctx.fillText("YOU SCORED "+this.currentScore+" POINTS",555.5,950)},GameState.prototype.dayScreen=function(){this.screenTimer--,this.screenTimer>=0?(ctx.fillStyle="rgba(0,0,0,0.5)",ctx.fillRect(0,0,1111,1500),ctx.fillStyle="#fff",ctx.textAlign="center",ctx.font="Bold 30px Arial Black",ctx.fillText(this.coffeeCount+" COWORKERS WANT A COFFEE",555.5,500),ctx.font="Bold 120px Arial Black",ctx.fillText("DAY "+this.level,555.5,650)):this.screenTimer<=0&&(game.state.setMode("play"),this.resetScreenTimer())},GameState.prototype.startScreen=function(){this.button||this.makeStartButton(),ctx.fillStyle="rgba(0,0,0,0.7)",ctx.fillRect(0,0,1111,1500),ctx.textAlign="center",ctx.fillStyle="#fff",ctx.fillText("IT'S TIME TO START YOUR",555.5,500),ctx.font="Bold 120px Arial Black",ctx.fillText("INTERNSHIP!",555.5,650),ctx.font="Normal 24px Arial",ctx.fillText("Each day more of your co-workers will realize there is a new intern.",555.5,875),ctx.fillText("Use the arrow keys to walk across the street, grab a coffee, and then",555.5,906),ctx.fillText("bring it back before its cold.",555.5,937)},GameState.prototype.pauseScreen=function(){ctx.fillStyle="rgba(0,0,0,0.7)",ctx.fillRect(0,0,1111,1500),ctx.textAlign="center",ctx.fillStyle="#fff",ctx.fillText("COMPOSE YOURSELF",555.5,500),ctx.font="Bold 120px Arial Black",ctx.fillText("GAME PAUSED",555.5,650),ctx.font="Normal 24px Arial"},GameState.prototype.renderHud=function(){ctx.fillStyle="#000",ctx.fillRect(0,0,1222,1222),ctx.fillStyle="#fff",ctx.textAlign="left",ctx.font="Bold 30px Verdana",ctx.fillText("Day: "+this.level,175,145),ctx.fillText("Get "+(this.coffeeCount-game.player.gotCoffees)+" Coffees",335,145),ctx.fillText("Score: "+this.currentScore,625,145),ctx.fillText("Time: "+Math.floor(this.coffeeTimer/60),945,145),this.renderLives()};var MapTile=function(){this.width=101,this.height=83,this.pos=[0,0],this.sprite="images/default-block.png"};MapTile.prototype.setPos=function(t,e){this.pos=[t,e]},MapTile.prototype.render=function(){ctx.drawImage(Resources.get(this.sprite),this.pos[0],this.pos[1])};var Building=function(){MapTile.call(this),this.width=202,this.height=83,this.sprite="images/building1.png"};Building.prototype=Object.create(MapTile.prototype),Building.prototype.constructor=Building;var Road=function(){MapTile.call(this),this.width=202,this.height=83,this.sprite="images/road.png"};Road.prototype=Object.create(MapTile.prototype),Road.prototype.constructor=Road;var Shoulder=function(){MapTile.call(this),this.width=202,this.height=83,this.sprite="images/shoulder.png"};Shoulder.prototype=Object.create(MapTile.prototype),Shoulder.prototype.constructor=Shoulder;var Sidewalk=function(){MapTile.call(this),this.width=202,this.height=83,this.sprite="images/sidewalk-top.png"};Sidewalk.prototype=Object.create(MapTile.prototype),Sidewalk.prototype.constructor=Sidewalk;var SidewalkBottom=function(){MapTile.call(this),this.width=202,this.height=83,this.sprite="images/sidewalk-bottom.png"};SidewalkBottom.prototype=Object.create(MapTile.prototype),SidewalkBottom.prototype.constructor=SidewalkBottom;var GameMap=function(t,e,i,o,s){this.width=t,this.height=e-o+83,this.grid=i,this.HUDoffset=o,this.xUnit=this.width/i.width,this.yUnit=(this.height-o)/i.height,this.bounds={x:[0,11],y:[0,12]},this.startPoint={x:505,y:980},this.tileSet=this.createTileSet(s)};GameMap.prototype.render=function(){for(var t=0,e=this.tileSet.length;e>t;t++)this.tileSet[t].render()},GameMap.prototype.getTileSet=function(){return this.tileSet},GameMap.prototype.getTile=function(t){this.types={0:MapTile,1:Building,2:Shoulder,3:Road,4:Sidewalk,5:SidewalkBottom};var e=this.types[t];return new e},GameMap.prototype.createTileSet=function(t){for(var e=[],i=0,o=0,s=t.length;s>o;o++){var n=0,a=0;if(0===t[o].repeat)for(var r=0,h=t[o].tiles.length;h>r;r++){var p=this.getTile(t[o].tiles[r]);p.height>n&&(n=p.height),p.setPos(a*this.xUnit,i*this.yUnit+this.HUDoffset),e.push(p),a++}else if(1==t[o].repeat)for(var c=0,l=this.width;l>c;){var f=this.getTile(t[o].tiles[0]);c+=f.width,f.setPos(a*f.width,i*this.yUnit+this.HUDoffset),e.push(f),a++}i++}return e};var Entity=function(){this.width=60,this.height=75,this.step={x:101,y:83},this.hitOffset={x:0,y:57},this.sprite="images/char-boy.png"};Entity.prototype.render=function(){ctx.drawImage(Resources.get(this.sprite),this.x,this.y+game.HUDoffset)},Entity.prototype.hitBoxLeft=function(){return this.x+this.hitOffset.x},Entity.prototype.hitBoxTop=function(){return this.y+this.hitOffset.y},Entity.prototype.collide=function(){};var Coffee=function(){Entity.call(this),this.sprite="images/coffee.png",this.x=Math.floor(10*Math.random()+1)*this.step.x,this.y=1*this.step.y,this.width=70,this.height=55,this.value=100};Coffee.prototype=Object.create(Entity.prototype),Coffee.prototype.contructor=Coffee,Coffee.prototype.collide=function(t){game.playAudio("sounds/bell.mp3"),t.hasCoffee=1,game.removeItem(this),game.state.updateScore(this.value),game.addItem(new HomeOffice)};var HomeOffice=function(){Entity.call(this),this.sprite="images/target.png",this.x=Math.floor(10*Math.random()+1)*this.step.x,this.y=12*this.step.y,this.width=83,this.height=101,this.value=1e3};HomeOffice.prototype=Object.create(Entity.prototype),HomeOffice.prototype.constructor=HomeOffice,HomeOffice.prototype.collide=function(t){t.hasCoffee=0,game.state.resetCoffeeTimer(),game.removeItem(this),game.state.updateScore(this.value),game.addItem(new Coffee),t.gotCoffees<game.state.coffeeCount&&(t.gotCoffees+=1),t.gotCoffees==game.state.coffeeCount&&(t.gotCoffees=0,game.state.level+=1,game.state.coffeeCount+=1,game.state.setMode("day"))};var Enemy=function(t,e){Entity.call(this),this.start=-1*this.step.x,this.sprite="images/enemy-bug.png",this.x=t*this.step.x,this.y=e*this.step.y,this.width=96,this.height=57};Enemy.prototype=Object.create(Entity.prototype),Enemy.prototype.constructor=Enemy,Enemy.prototype.collide=function(t){game.playAudio("sounds/crash.mp3"),game.playAudio("sounds/hit.mp3"),t.die()},Enemy.prototype.update=function(t,e){this.x=this.x>this.step.x*e.x[1]?this.start:this.x+this.speed*t};var Hatch=function(t,e,i){Enemy.call(this,t,e,i),i="undefined"!=typeof i?i:1,this.speed=i*this.step.x,this.sprite="images/hatch.png"};Hatch.prototype=Object.create(Enemy.prototype),Hatch.prototype.constructor=Hatch;var Sedan=function(t,e,i){Enemy.call(this,t,e,i),this.speed=i*this.step.x,this.sprite="images/hatch-left.png"};Sedan.prototype=Object.create(Enemy.prototype),Sedan.prototype.constructor=Sedan,Sedan.prototype.update=function(t,e){this.start=(e.x[1]+1)*this.step.x,this.x=this.x<e.x[0]-this.step.x?this.start:this.x+this.speed*t};var Coupe=function(t,e,i){Enemy.call(this,t,e,i),this.sprite="images/coupe.png",this.speed=i*this.step.x,this.width=126};Coupe.prototype=Object.create(Enemy.prototype),Coupe.prototype.constructor=Coupe;var Van=function(t,e,i){Enemy.call(this,t,e,i),this.sprite="images/van.png",this.speed=i*this.step.x,this.width=126};Van.prototype=Object.create(Enemy.prototype),Van.prototype.constructor=Van,Van.prototype.update=function(t,e){this.start=e.x[1]*this.step.x,this.x=this.x<e.x[0]-(this.width+202)?this.start:this.x+this.speed*t};var Semi=function(t,e,i){Enemy.call(this,t,e,i),this.sprite=this.randomColor("semi"),this.speed=i*this.step.x,this.width=238,this.hitOffset.x=5};Semi.prototype=Object.create(Enemy.prototype),Semi.prototype.constructor=Semi,Semi.prototype.update=function(t,e){this.x=this.x>this.step.x*e.x[1]?this.start-this.width:this.x+this.speed*t},Semi.prototype.randomColor=function(t){var e=Math.floor(3*Math.random()+1),i="images/"+t+e.toString()+".png";return i};var SemiReverse=function(t,e,i){Semi.call(this,t,e,i),this.sprite=this.randomColor("semi-reverse"),this.hitOffset.x=58};SemiReverse.prototype=Object.create(Semi.prototype),SemiReverse.prototype.constructor=SemiReverse,SemiReverse.prototype.update=function(t,e){this.start=e.x[1]*this.step.x,this.x=this.x<e.x[0]-(this.width+202)?this.start:this.x+this.speed*t};var Player=function(t,e){Entity.call(this),this.lives=3,this.x=t,this.y=e,this.hitOffset={x:21,y:51},this.hasCoffee=0,this.gotCoffees=0,this.sprite="images/man.png",this.bounds=game.map.bounds,this.actions={up:function(){this.y=this.checkBounds(this.y-this.step.y,this.bounds.y,this.step.y,this.y)},right:function(){this.x=this.checkBounds(this.x+this.step.x,this.bounds.x,this.step.x,this.x)},down:function(){this.y=this.checkBounds(this.y+this.step.y,this.bounds.y,this.step.y,this.y)},left:function(){this.x=this.checkBounds(this.x-this.step.x,this.bounds.x,this.step.x,this.x)}}};Player.prototype=Object.create(Entity.prototype),Player.prototype.constructor=Player,Player.prototype.update=function(){this.x=this.x},Player.prototype.checkBounds=function(t,e,i,o){return t>=e[0]*i&&t<e[1]*i?t:o},Player.prototype.handleInput=function(t){"play"==game.state.checkMode()&&this.actions[t].call(this)},Player.prototype.die=function(){this.lives>1?(this.lives=this.lives-1,game.resetStage(),this.hasCoffee=0,game.state.resetCoffeeTimer()):(this.lives=this.lives-1,game.resetStage(),game.state.setMode("over"),game.playAudio("sounds/trombone.mp3"),game.playAudio("sounds/boo.mp3"),this.hasCoffee=0,game.state.resetCoffeeTimer())},Player.prototype.reset=function(t){this.x=t.x,this.y=t.y};var EntityHash=function(t){this.idx={},this.cellSize=t};EntityHash.prototype.insert=function(t,e,i){var o=[],s=this.keys(t,e);for(var n in s){var a=s[n];a in this.idx?o=this.idx[a]:this.idx[a]=o,-1==o.indexOf(i)&&o.push(i)}},EntityHash.prototype.clear=function(){this.idx={}},EntityHash.prototype.query=function(t,e){var i=this.key(t,e);return void 0!==this.idx[i]?this.idx[i]:[]},EntityHash.prototype.keys=function(t,e){var i=this.cellSize/2;return[this.key(t-i,e+0),this.key(t-0,e+0),this.key(t+i,e+0),this.key(t-i,e+i),this.key(t-0,e+i),this.key(t+i,e+i),this.key(t-i,e-i),this.key(t-0,e-i),this.key(t+i,e-i)]},EntityHash.prototype.key=function(t,e){var i=this.cellSize;return t=Math.floor(t/i)*i,e=Math.floor(e/i)*i,t.toString()+":"+e.toString()};var buttonPosition=debounce(function(){var t=document.getElementById("canvas");t.style.height=window.innerHeight+"px";var e=t.getBoundingClientRect(),o=document.getElementsByClassName("btn");for(i=0,l=o.length;i<l;i++)o[i].style.left=e.left+(e.width-150)/2+"px",o[i].style.top=e.top+(e.height-40)/1.75+"px"});window.addEventListener("resize",buttonPosition,!0),document.addEventListener("keyup",function(t){var e={37:"left",38:"up",39:"right",40:"down"};game.player.handleInput(e[t.keyCode])});